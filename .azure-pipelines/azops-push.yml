name: AzOps

trigger: none

pool:
  vmImage: "ubuntu-latest"

variables:
  DOCKER_IMAGE: mscet/azops:main
  DOCKER_VERSION: 19.03.12
  SCM_PLATFORM: AzureDevOps
  AZOPS_DEFAULT_DEPLOYMENT_REGION: northeurope
  AZOPS_ENROLLMENT_ACCOUNT: ""
  AZOPS_IGNORE_CONTEXT_CHECK: 0
  AZOPS_INVALIDATE_CACHE: 1
  AZOPS_OFFER_TYPE: MS-AZR-0017P
  AZOPS_SKIP_POLICY: 0
  AZOPS_SKIP_RESOURCE_GROUP: 1
  AZOPS_STATE: azops
  AZOPS_STRICT_MODE: 1
  AZOPS_THROTTLE_LIMIT: 10
  AZDEVOPS_USERNAME: AzOps
  AZDEVOPS_EMAIL: noreply@azure.com
  AZDEVOPS_PULL_REQUEST: "Azure Change Notification"
  AZDEVOPS_AUTO_MERGE: 1
  DEBUG: 0
  VERBOSE: 0

jobs:
  - job: Push
    condition: and(eq(variables['Build.Reason'], 'PullRequest'), ne(variables['System.PullRequest.SourceBranch'], 'refs/heads/system'))
    steps:
      - checkout: self
        persistCredentials: true

      - task: DockerInstaller@0
        displayName: Install Docker
        inputs:
          dockerVersion: $(DOCKER_VERSION)
          releaseType: stable

      - task: Bash@3
        displayName: Pull image
        inputs:
          targetType: "inline"
          script: |
            docker pull $(DOCKER_IMAGE)

      - task: Bash@3
        displayName: Run container
        inputs:
          targetType: "inline"
          script: |
            docker run --rm \
              --volume=/root:/root \
              --volume=`pwd`:`pwd` \
              --workdir `pwd` \
              --env-file "./settings.env" \
              --env AZURE_CREDENTIALS="$(AZURE_CREDENTIALS)" \
              --env AZDEVOPS_HEAD_REF=$(System.PullRequest.SourceBranch) \
              --env AZDEVOPS_BASE_REF=$(System.PullRequest.TargetBranch) \
              --env AZDEVOPS_API_URL=$(System.TeamFoundationCollectionUri) \
              --env AZDEVOPS_PROJECT_ID=$(System.TeamProjectId) \
              --env AZDEVOPS_REPOSITORY=$(Build.Repository.Name) \
              --env AZDEVOPS_PULL_REQUEST_ID=$(System.PullRequest.PullRequestId) \
              --env AZURE_DEVOPS_EXT_PAT="$(System.AccessToken)" \
              --env AZDEVOPS_TOKEN="$(System.AccessToken)" \
              --env INPUT_MODE="Push" \
              $(DOCKER_IMAGE)
