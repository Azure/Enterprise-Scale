{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "vnetName": {
            "type": "string",
            "defaultValue": "vnet01-sidecar",
            "metadata": {
                "description": "Name of new or existing vnet"
            }
        },
        "vnetIpPrefix": {
            "type": "string",
            "defaultValue": "10.101.0.0/16",
            "metadata": {
                "description": "IP prefix for available addresses in vnet address space"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Azure region for Bastion and virtual network"
            }
        },
        "topLevelManagementGroupPrefix": {
            "type": "string",
            "metadata": {
                "description": "Name of the intermediate root management group"
            }
        },
        "resourceGroupOverride": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Name of the resource group to deploy to"
            }
        }
    },
    "variables": {
        "resourceDeploymentName": "[format('{0}-deployment', parameters('vnetName'))]",
        "rgName": "[if(empty(parameters('resourceGroupOverride')), concat(parameters('topLevelManagementGroupPrefix'), '-vnethub-', parameters('location')), parameters('resourceGroupOverride'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-09-01",
            "name": "alz-vwancheck-uai",
            "resourceGroup": "[variables('rgName')]",
            "properties": {
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    }
                },
                "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                    "location": {
                    "type": "string"
                    }
                },
                "variables": {},
                "resources": [
                    {
                        "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                        "apiVersion": "2022-01-31-preview",
                        "name": "[format('uai-avnm-{0}', parameters('location'))]",
                        "location": "[parameters('location')]",
                        "metadata": {
                            "description": "This user assigned identity is used by the Deployment Script resource to interact with Azure resources."
                        }
                    },
                    {
                        "type": "Microsoft.Authorization/roleAssignments",
                        "apiVersion": "2022-04-01",
                        "name": "[guid(resourceGroup().id, format('uai-vwancheck-{0}', parameters('location')))]",
                        "properties": {
                            "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
                            "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-vwancheck-{0}', parameters('location'))), '2022-01-31-preview').principalId]",
                            "principalType": "ServicePrincipal"
                        },
                        "dependsOn": [
                            "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-vwancheck-{0}', parameters('location')))]"
                        ],
                        "metadata": {
                            "description": "This role assignment grants the user assigned identity the Contributor role on the resource group."
                        }
                    }
                ],
                "outputs": {
                    "userAssignedIdentityId": {
                        "type": "string",
                        "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-vwancheck-{0}', parameters('location')))]"
                    }
                }
                }
            },
            "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
            ]
            },
            {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-09-01",
            "name": "[format('ds-{0}-prereqs', parameters('location'))]",
            "resourceGroup": "[variables('rgName')]",
            "properties": {
                    "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                    "location": {
                        "value": "[parameters('location')]"
                    },
                    "locationSecondary": {
                        "value": "[parameters('locationSecondary')]"
                    },
                    "userAssignedIdentityId": {
                        "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', 'alz-avnm-uai'), '2022-09-01').outputs.userAssignedIdentityId.value]"
                    },
                    "rgName": {
                        "value": "[variables('rgName')]"
                    },
                    "configIds": {
                        "value": "[variables('configIds')]"
                    },
                    "connectivitySubscriptionId": {
                        "value": "[parameters('connectivitySubscriptionId')]"
                    }
                },
                "template": {
                "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                "contentVersion": "1.0.0.0",
                "parameters": {
                    "location": {
                        "type": "string"
                    },
                    "locationSecondary": {
                        "type": "string"
                    },
                    "userAssignedIdentityId": {
                        "type": "string"
                    },
                    "rgName": {
                        "type": "string"
                    },
                    "configIds": {
                        "type": "string"
                    },
                    "connectivitySubscriptionId": {
                        "type": "string"
                    }
                },
                "resources": [
                    {
                        "type": "Microsoft.Resources/deploymentScripts",
                        "apiVersion": "2020-10-01",
                        "name": "alz-avnm-deploymentscript",
                        "location": "[parameters('location')]",
                        "kind": "AzurePowerShell",
                        "identity": {
                            "type": "UserAssigned",
                            "userAssignedIdentities": {
                                "[format('{0}', parameters('userAssignedIdentityId'))]": {}
                        }
                    },
                    "properties": {
                            "azPowerShellVersion": "12.3",
                            "retentionInterval": "PT1H",
                            "timeout": "PT1H",
                            "arguments": "[format('-location \"{0}\" -locationSecond \"{1}\" -rgName \"{2}\" -configIds \"{3}\" -connSubId \"{4}\"', parameters('location'), parameters('locationSecondary'), parameters('rgName'), parameters('configIds'), parameters('connectivitySubscriptionId'))]",
                            "scriptContent": "
                                param(
                                    [string]
                                    $location,

                                    [string]
                                    $locationSecond,

                                    [string]
                                    $rgName,

                                    [string]
                                    $configIds,

                                    [string]
                                    $connSubId
                                )

                                $regions = @($location, $locationSecond)

                                Select-AzSubscription -SubscriptionId $connSubId

                                Deploy-AzNetworkManagerCommit -ResourceGroupName $rgName -Name \"avnm\" -TargetLocation $regions -CommitType \"SecurityAdmin\" -ConfigurationId $configIds
                                
                            "
                        }
                    }
                ],
                    "outputs": {}
                }
            },
            "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('rgName')), 'Microsoft.Resources/deployments', variables('resourceDeploymentName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('rgName'))]"
            ]
        }
    ]
}