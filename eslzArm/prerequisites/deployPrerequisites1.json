{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/managementGroupDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "resourceGroupName": {
        "type": "string",
        "defaultValue": "rg-alz-prereqs",
        "metadata": {
          "description": "The resource group name where the AVNM resources will be created"
        }
      },
      "location": {
        "type": "string",
        "minLength": 6,
        "metadata": {
          "description": "The location of this AVNM instance. All resources will be deployed to this region."
        }
      },
      "eslzRootName": {
        "type": "string",
        "metadata": {
          "description": "The name of the Enterprise Scale Landing Zone root resource."
        }
      },
      "managementSubscriptionId": {
        "type": "string",
        "metadata": {
          "description": "The subscription ID of the management subscription."
        }
      }
    },
    "resources": [
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2022-09-01",
        "name": "alz-prerequisites",
        "location": "[parameters('location')]",
        "subscriptionId": "[parameters('managementSubscriptionId')]",
        "properties": {
          "mode": "Incremental",
          "template": {
            "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
            "contentVersion": "1.0.0.0",
            "resources": [
                {
                    "type": "Microsoft.Resources/resourceGroups",
                    "apiVersion": "2022-09-01",
                    "name": "[parameters('resourceGroupName')]",
                    "location": "[parameters('location')]"
                },
                {
                    "type": "Microsoft.Resources/deployments",
                    "apiVersion": "2022-09-01",
                    "name": "alz-prerequisites-uai",
                    "resourceGroup": "[parameters('resourceGroupName')]",
                    "properties": {
                    "expressionEvaluationOptions": {
                        "scope": "inner"
                    },
                    "mode": "Incremental",
                    "parameters": {
                        "location": {
                        "value": "[parameters('location')]"
                        },
                        "eslzRootName": {
                        "value": "[parameters('eslzRootName')]"
                        }
                    },
                    "template": {
                        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                        "contentVersion": "1.0.0.0",
                        "parameters": {
                        "location": {
                            "type": "string"
                        },
                        "eslzRootName": {
                            "type": "string"
                        }
                        },
                        "variables": {},
                        "resources": [
                        {
                            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                            "apiVersion": "2022-01-31-preview",
                            "name": "[format('uai-prereq-{0}', parameters('location'))]",
                            "location": "[parameters('location')]",
                            "metadata": {
                            "description": "This user assigned identity is used by the Deployment Script resource to interact with Azure resources."
                            }
                        },
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[guid(resourceGroup().id, format('uai-prereq-{0}', parameters('location')))]",
                            "scope": "[format('/providers/Microsoft.Management/managementGroups/{0}', parameters('eslzRootName'))]",
                            "properties": {
                            "roleDefinitionId": "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
                            "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-prereq-{0}', parameters('location'))), '2022-01-31-preview').principalId]",
                            "principalType": "ServicePrincipal"
                            },
                            "dependsOn": [
                            "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-prereq-{0}', parameters('location')))]"
                            ],
                            "metadata": {
                            "description": "This role assignment grants the user assigned identity the Contributor role on the resource group."
                            }
                        }
                        ],
                        "outputs": {
                        "userAssignedIdentityId": {
                            "type": "string",
                            "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', format('uai-prereq-{0}', parameters('location')))]"
                        }
                        }
                    }
                    },
                    "dependsOn": [
                        "[subscriptionResourceId(parameters('managementSubscriptionId'),'Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
                        "alz-prerequisites-createRG"
                    ]
                }
            ]
          }
        }
      }
    ],
    "outputs": {}
  }