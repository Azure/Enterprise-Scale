{
    "name": "Enforce-Guardrails-Storage",
    "type": "Microsoft.Authorization/policySetDefinitions",
    "apiVersion": "2021-06-01",
    "scope": null,
    "properties": {
        "policyType": "Custom",
        "displayName": "Enforce secure-by-default Storage Account for regulated industries",
        "description": "This policy initiative is a group of policies that ensures Storage is compliant per regulated Landing Zones.",
        "metadata": {
            "version": "1.0.0",
            "category": "Storage",
            "source": "https://github.com/Azure/Enterprise-Scale/",
            "alzCloudEnvironments": [
                "AzureCloud",
                "AzureChinaCloud",
                "AzureUSGovernment"
            ],
            "alzVariant": [
                "FSI"
            ]
        },
        "parameters": {
            "storageKeysExpiration": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "modifyStorageFileSyncPublicEndpoint": {
                "type": "string",
                "defaultValue": "Modify"
            },
            "storageFileSyncPublicEndpoint": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountNetworkRules": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountRestrictNetworkRules": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageThreatProtection": {
                "type": "string",
                "defaultValue": "DeployIfNotExists"
            },
            "storageClassicToArm": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountSecureTransfer": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsInfraEncryption": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsPublicAccess": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsCmk": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageTableCmk": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountSharedKey": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsCrossTenant": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsModifyDisablePublicNetworkAccess": {
                "type": "string",
                "defaultValue": "Modify"
            },
            "storageAccountsDisablePublicNetworkAccess": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsDoubleEncryption": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageQueueCmk": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsTls": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsEncryptionCmk": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsCopyScope": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAccountsAllowedCopyScope": {
                "type": "string",
                "defaultValue": "AAD"
            },
            "storageServicesEncryption": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageLocalUser": {
                "type": "string",
                "defaultValue": "Disabled"
            },
            "storageSftp": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageNetworkAclsBypass": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAllowedNetworkAclsBypass": {
                "type": "array",
                "defaultValue": [
                    "None"
                ]
            },
            "storageResourceAccessRulesTenantId": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageResourceAccessRulesResourceId": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageNetworkAclsVirtualNetworkRules": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageAllowBlobPublicAccess": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageContainerDeleteRetentionPolicy": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "storageMinContainerDeleteRetentionInDays": {
                "type": "Integer",
                "defaultValue": 7
            },
            "storageCorsRules": {
                "type": "string",
                "defaultValue": "Deny"
            },
            "modifyStorageAccountPublicEndpoint": {
                "type": "string",
                "defaultValue": "Modify"
            }
        },
        "policyDefinitions": [
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/6fac406b-40ca-413b-bf8e-0bf964659c25",
                "policyDefinitionReferenceId": "Deny-Storage-Cmk",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsCmk')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-CopyScope",
                "policyDefinitionReferenceId": "Deny-Storage-CopyScope",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsCopyScope')]"
                    },
                    "allowedCopyScope": {
                        "value": "[[parameters('storageAccountsAllowedCopyScope')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-ServicesEncryption",
                "policyDefinitionReferenceId": "Deny-Storage-ServicesEncryption",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageServicesEncryption')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-LocalUser",
                "policyDefinitionReferenceId": "Deny-Storage-LocalUser",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageLocalUser')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-Sftp",
                "policyDefinitionReferenceId": "Deny-Storage-Sftp",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageSftp')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-NetworkAclsBypass",
                "policyDefinitionReferenceId": "Deny-Storage-NetworkAclsBypass",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageNetworkAclsBypass')]"
                    },
                    "allowedBypassOptions": {
                        "value": "[[parameters('storageAllowedNetworkAclsBypass')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-ResourceAccessRulesTenantId",
                "policyDefinitionReferenceId": "Deny-Storage-ResourceAccessRulesTenantId",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageResourceAccessRulesTenantId')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-ResourceAccessRulesResourceId",
                "policyDefinitionReferenceId": "Deny-Storage-ResourceAccessRulesResourceId",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageResourceAccessRulesResourceId')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-NetworkAclsVirtualNetworkRules",
                "policyDefinitionReferenceId": "Deny-Storage-NetworkAclsVirtualNetworkRules",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageNetworkAclsVirtualNetworkRules')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751",
                "policyDefinitionReferenceId": "Deny-Storage-AllowBlobPublicAccess",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAllowBlobPublicAccess')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-ContainerDeleteRetentionPolicy",
                "policyDefinitionReferenceId": "Deny-Storage-ContainerDeleteRetentionPolicy",
                "groupNames": [],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageContainerDeleteRetentionPolicy')]"
                    },
                    "minContainerDeleteRetentionInDays": {
                        "value": "[[parameters('storageMinContainerDeleteRetentionInDays')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Management/managementGroups/contoso/providers/Microsoft.Authorization/policyDefinitions/Deny-Storage-CorsRules",
                "policyDefinitionReferenceId": "Deny-Storage-CorsRules",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageCorsRules')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b5ec538c-daa0-4006-8596-35468b9148e8",
                "policyDefinitionReferenceId": "Deny-Storage-Encryption-Cmk",
                "groupNames": [
                    "Encryption"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsEncryptionCmk')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/fe83a0eb-a853-422d-aac2-1bffd182c5d0",
                "policyDefinitionReferenceId": "Deny-Storage-Tls",
                "groupNames": [
                    "Network",
                    "Encryption"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsTls')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/f0e5abd0-2554-4736-b7c0-4ffef23475ef",
                "policyDefinitionReferenceId": "Deny-Storage-Queue-Cmk",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageQueueCmk')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/bfecdea6-31c4-4045-ad42-71b9dc87247d",
                "policyDefinitionReferenceId": "Deny-Storage-Account-Encryption",
                "groupNames": [
                    "Encryption"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsDoubleEncryption')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b2982f36-99f2-4db5-8eff-283140c09693",
                "policyDefinitionReferenceId": "Deny-Storage-Account-PublicEndpoint",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsDisablePublicNetworkAccess')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/a06d0189-92e8-4dba-b0c4-08d7669fce7d",
                "policyDefinitionReferenceId": "Modify-Storage-Account-PublicEndpoint",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsModifyDisablePublicNetworkAccess')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/92a89a79-6c52-4a7e-a03f-61306fc49312",
                "policyDefinitionReferenceId": "Deny-Storage-Cross-Tenant",
                "groupNames": [
                    "Encryption",
                    "Identity"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsCrossTenant')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/8c6a50c6-9ffd-4ae7-986f-5fa6111f9a54",
                "policyDefinitionReferenceId": "Deny-Storage-Shared-Key",
                "groupNames": [
                    "Encryption",
                    "Identity"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountSharedKey')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/7c322315-e26d-4174-a99e-f49d351b4688",
                "policyDefinitionReferenceId": "Deny-Storage-Table-Cmk",
                "groupNames": [
                    "Encryption"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageTableCmk')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4fa4b6c0-31ca-4c0d-b10d-24b96f62a751",
                "policyDefinitionReferenceId": "Deny-Storage-Public-Access",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsPublicAccess')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/4733ea7b-a883-42fe-8cac-97454c2a9e4a",
                "policyDefinitionReferenceId": "Deny-Storage-Infra-Encryption",
                "groupNames": [
                    "Encryption"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountsInfraEncryption')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/404c3081-a854-4457-ae30-26a93ef643f9",
                "policyDefinitionReferenceId": "Deny-Storage-SecureTransfer",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountSecureTransfer')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/37e0d2fe-28a5-43d6-a273-67d37d1f5606",
                "policyDefinitionReferenceId": "Deny-Storage-Classic",
                "groupNames": [
                    "Identity"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageClassicToArm')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/361c2074-3595-4e5d-8cab-4f21dffc835c",
                "policyDefinitionReferenceId": "Dine-Storage-Threat-Protection",
                "groupNames": [
                    "Logging"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageThreatProtection')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/34c877ad-507e-4c82-993e-3452a6e0ad3c",
                "policyDefinitionReferenceId": "Deny-Storage-Restrict-NetworkRules",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountRestrictNetworkRules')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/2a1a9cdf-e04d-429a-8416-3bfb72a1b26f",
                "policyDefinitionReferenceId": "Deny-Storage-NetworkRules",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageAccountNetworkRules')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/21a8cd35-125e-4d13-b82d-2e19b7208bb7",
                "policyDefinitionReferenceId": "Deny-Storage-FileSync-PublicEndpoint",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageFileSyncPublicEndpoint')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/13502221-8df0-4414-9937-de9c5c4e396b",
                "policyDefinitionReferenceId": "Modify-Blob-Storage-Account-PublicEndpoint",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('modifyStorageAccountPublicEndpoint')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/0e07b2e9-6cd9-4c40-9ccb-52817b95133b",
                "policyDefinitionReferenceId": "Modify-Storage-FileSync-PublicEndpoint",
                "groupNames": [
                    "Network"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('modifyStorageFileSyncPublicEndpoint')]"
                    }
                }
            },
            {
                "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/044985bb-afe1-42cd-8a36-9d5d42424537",
                "policyDefinitionReferenceId": "Deny-Storage-Account-Keys-Expire",
                "groupNames": [
                    "Encryption"
                ],
                "parameters": {
                    "effect": {
                        "value": "[[parameters('storageKeysExpiration')]"
                    }
                }
            }
        ],
        "policyDefinitionGroups": null
    }
}