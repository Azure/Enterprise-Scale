name: AzOps

on:
  repository_dispatch:
    types:
      - "azure-activity-logs"
      - "github-cli"
  pull_request:
    branches:
      - main
    paths:
      - "azops/**"
  pull_request_review:
    branches:
      - main
    types: [submitted]
    paths:
      - "azops/**"

env:
  # Actions
  actions_push: true
  actions_push_review: false
  actions_pull: true
  # Azure
  azure_credentials: ${{ secrets.AZURE_CREDENTIALS }}
  # AzOps
  azops_state: "azops"
  azops_default_deployment_region: "northeurope"
  azops_enrollment_account_principal_name: ""
  azops_offer_type: "MS-AZR-0017P"
  azops_ignore_context_check: "0"
  azops_invalidate_cache: "1"
  azops_throttle_limit: "10"
  # GitHub
  github_user: "AzOps"
  github_email: "noreply@azure.com"
  github_pull_request: "Azure Change Notification"
  github_context: ${{ toJson(github) }}
  github_issue: ${{ github.event.pull_request._links.issue.href }}
  github_comments: ${{ github.event.pull_request._links.comments.href }}
  github_base_ref: ${{ github.event.pull_request.base.ref }}
  github_head_ref: ${{ github.event.pull_request.head.ref }}
  # PowerShell
  verbose: false
  debug: false

jobs:

  push:
    if: ${{ env.actions_push == true && github.head_ref != 'system' && github.event_name == 'pull_request' }}
    name: Push
    runs-on: ubuntu-latest
    steps:
      - name: Actions checkout
        uses: actions/checkout@v2
      - name: GitHub context
        run: echo "$GITHUB_CONTEXT"
      - name: Actions azops
        uses: Azure/AzOps@main
        with:
          mode: push

  # If you want review before triggering the push event, set push_with_review env to true.
  # Review will require, someone other than the creator of the pull request to complete review.
  # Workflow will run once pull request is reviewed with a comment that contains "LGTM".
  # In order for GitHub Actions status check to display in your PR, you have to enable branch access policy.
  push_with_review:
    if: ${{ env.actions_push_review == true && github.head_ref != 'system' && contains(github.event.review.body, 'LGTM')}}
    name: Push
    runs-on: ubuntu-latest
    steps:
      - name: Actions checkout
        uses: actions/checkout@v2
      - name: GitHub context
        run: echo "$GITHUB_CONTEXT"
      - name: Actions azops
        uses: Azure/AzOps@main
        with:
          mode: push

  pull:
    if: ${{ env.actions_pull == true && github.event_name == 'repository_dispatch' }}
    name: Pull
    runs-on: ubuntu-latest
    steps:
      - name: Actions checkout
        uses: actions/checkout@v2
      - name: GitHub context
        run: echo "$GITHUB_CONTEXT"
      - name: Actions azops
        uses: Azure/AzOps@main
        with:
          mode: pull
