name: Reference

on: 
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        
jobs:
  reference:
    name: Reference
    runs-on: ubuntu-latest
    steps:
      - name: Actions checkout
        uses: actions/checkout@v2
        with:
          path: enterprise-scale
      - name: Actions checkout
        uses: actions/checkout@v2
        with:
          repository: Azure/AzOps
          path: azops
      - name: Run script
        shell: pwsh
        run: |
            $credentials = ($env:AZURE_CREDENTIALS | ConvertFrom-Json)
            $credential = New-Object System.Management.Automation.PSCredential -ArgumentList $credentials.clientId, ($credentials.clientSecret | ConvertTo-SecureString -AsPlainText -Force)
            Write-Host "Connecting context"
            Connect-AzAccount -TenantId $credentials.tenantId -ServicePrincipal -Credential $credential -SubscriptionId $credentials.subscriptionId -WarningAction SilentlyContinue | Out-Null
            Write-Host "Adding environment variable"
            $env:PSModulePath = $env:PSModulePath + ":/usr/share/az_4.3.0"
            Write-Host "Importing azops module"
            Import-Module .\azops\src\AzOps.psd1 -Force
            Write-Host "Removing azopsreference directory"
            Remove-Item -Path ".\enterprise-scale\azopsreference\3fc1081d-6105-4e19-b60c-1ec1252cf560" -Recurse -Force
            Write-Host "Initializing azopsreference directory"
            Initialize-AzOpsRepository -SkipResourceGroup -GeneralizeTemplates -Force
        env:
          AzOpsState: '.\AzOpsReference'
          GeneralizeTemplates: '1'
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}